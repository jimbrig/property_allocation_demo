<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>allocation</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
<style type="text/css">
a.anchor-section {margin-left: 10px; visibility: hidden; color: inherit;}
a.anchor-section::before {content: '#';}
.hasAnchor:hover a.anchor-section {visibility: visible;}
</style>
<script>// Anchor sections v1.0 written by Atsushi Yasumoto on Oct 3rd, 2020.
document.addEventListener('DOMContentLoaded', function() {
  // Do nothing if AnchorJS is used
  if (typeof window.anchors === 'object' && anchors.hasOwnProperty('hasAnchorJSLink')) {
    return;
  }

  const h = document.querySelectorAll('h1, h2, h3, h4, h5, h6');

  // Do nothing if sections are already anchored
  if (Array.from(h).some(x => x.classList.contains('hasAnchor'))) {
    return null;
  }

  // Use section id when pandoc runs with --section-divs
  const section_id = function(x) {
    return ((x.classList.contains('section') || (x.tagName === 'SECTION'))
            ? x.id : '');
  };

  // Add anchors
  h.forEach(function(x) {
    const id = x.id || section_id(x.parentElement);
    if (id === '') {
      return null;
    }
    let anchor = document.createElement('a');
    anchor.href = '#' + id;
    anchor.classList = ['anchor-section'];
    x.classList.add('hasAnchor');
    x.appendChild(anchor);
  });
});
</script>
<script>$(document).ready(function(){
    if (typeof $('[data-toggle="tooltip"]').tooltip === 'function') {
        $('[data-toggle="tooltip"]').tooltip();
    }
    if ($('[data-toggle="popover"]').popover === 'function') {
        $('[data-toggle="popover"]').popover();
    }
});
</script>
<style type="text/css">
.lightable-minimal {
border-collapse: separate;
border-spacing: 16px 1px;
width: 100%;
margin-bottom: 10px;
}
.lightable-minimal td {
margin-left: 5px;
margin-right: 5px;
}
.lightable-minimal th {
margin-left: 5px;
margin-right: 5px;
}
.lightable-minimal thead tr:last-child th {
border-bottom: 2px solid #00000050;
empty-cells: hide;
}
.lightable-minimal tbody tr:first-child td {
padding-top: 0.5em;
}
.lightable-minimal.lightable-hover tbody tr:hover {
background-color: #f5f5f5;
}
.lightable-minimal.lightable-striped tbody tr:nth-child(even) {
background-color: #f5f5f5;
}
.lightable-classic {
border-top: 0.16em solid #111111;
border-bottom: 0.16em solid #111111;
width: 100%;
margin-bottom: 10px;
margin: 10px 5px;
}
.lightable-classic tfoot tr td {
border: 0;
}
.lightable-classic tfoot tr:first-child td {
border-top: 0.14em solid #111111;
}
.lightable-classic caption {
color: #222222;
}
.lightable-classic td {
padding-left: 5px;
padding-right: 5px;
color: #222222;
}
.lightable-classic th {
padding-left: 5px;
padding-right: 5px;
font-weight: normal;
color: #222222;
}
.lightable-classic thead tr:last-child th {
border-bottom: 0.10em solid #111111;
}
.lightable-classic.lightable-hover tbody tr:hover {
background-color: #F9EEC1;
}
.lightable-classic.lightable-striped tbody tr:nth-child(even) {
background-color: #f5f5f5;
}
.lightable-classic-2 {
border-top: 3px double #111111;
border-bottom: 3px double #111111;
width: 100%;
margin-bottom: 10px;
}
.lightable-classic-2 tfoot tr td {
border: 0;
}
.lightable-classic-2 tfoot tr:first-child td {
border-top: 3px double #111111;
}
.lightable-classic-2 caption {
color: #222222;
}
.lightable-classic-2 td {
padding-left: 5px;
padding-right: 5px;
color: #222222;
}
.lightable-classic-2 th {
padding-left: 5px;
padding-right: 5px;
font-weight: normal;
color: #222222;
}
.lightable-classic-2 tbody tr:last-child td {
border-bottom: 3px double #111111;
}
.lightable-classic-2 thead tr:last-child th {
border-bottom: 1px solid #111111;
}
.lightable-classic-2.lightable-hover tbody tr:hover {
background-color: #F9EEC1;
}
.lightable-classic-2.lightable-striped tbody tr:nth-child(even) {
background-color: #f5f5f5;
}
.lightable-material {
min-width: 100%;
white-space: nowrap;
table-layout: fixed;
font-family: Roboto, sans-serif;
border: 1px solid #EEE;
border-collapse: collapse;
margin-bottom: 10px;
}
.lightable-material tfoot tr td {
border: 0;
}
.lightable-material tfoot tr:first-child td {
border-top: 1px solid #EEE;
}
.lightable-material th {
height: 56px;
padding-left: 16px;
padding-right: 16px;
}
.lightable-material td {
height: 52px;
padding-left: 16px;
padding-right: 16px;
border-top: 1px solid #eeeeee;
}
.lightable-material.lightable-hover tbody tr:hover {
background-color: #f5f5f5;
}
.lightable-material.lightable-striped tbody tr:nth-child(even) {
background-color: #f5f5f5;
}
.lightable-material.lightable-striped tbody td {
border: 0;
}
.lightable-material.lightable-striped thead tr:last-child th {
border-bottom: 1px solid #ddd;
}
.lightable-material-dark {
min-width: 100%;
white-space: nowrap;
table-layout: fixed;
font-family: Roboto, sans-serif;
border: 1px solid #FFFFFF12;
border-collapse: collapse;
margin-bottom: 10px;
background-color: #363640;
}
.lightable-material-dark tfoot tr td {
border: 0;
}
.lightable-material-dark tfoot tr:first-child td {
border-top: 1px solid #FFFFFF12;
}
.lightable-material-dark th {
height: 56px;
padding-left: 16px;
padding-right: 16px;
color: #FFFFFF60;
}
.lightable-material-dark td {
height: 52px;
padding-left: 16px;
padding-right: 16px;
color: #FFFFFF;
border-top: 1px solid #FFFFFF12;
}
.lightable-material-dark.lightable-hover tbody tr:hover {
background-color: #FFFFFF12;
}
.lightable-material-dark.lightable-striped tbody tr:nth-child(even) {
background-color: #FFFFFF12;
}
.lightable-material-dark.lightable-striped tbody td {
border: 0;
}
.lightable-material-dark.lightable-striped thead tr:last-child th {
border-bottom: 1px solid #FFFFFF12;
}
.lightable-paper {
width: 100%;
margin-bottom: 10px;
color: #444;
}
.lightable-paper tfoot tr td {
border: 0;
}
.lightable-paper tfoot tr:first-child td {
border-top: 1px solid #00000020;
}
.lightable-paper thead tr:last-child th {
color: #666;
vertical-align: bottom;
border-bottom: 1px solid #00000020;
line-height: 1.15em;
padding: 10px 5px;
}
.lightable-paper td {
vertical-align: middle;
border-bottom: 1px solid #00000010;
line-height: 1.15em;
padding: 7px 5px;
}
.lightable-paper.lightable-hover tbody tr:hover {
background-color: #F9EEC1;
}
.lightable-paper.lightable-striped tbody tr:nth-child(even) {
background-color: #00000008;
}
.lightable-paper.lightable-striped tbody td {
border: 0;
}
</style>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap;
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #d14; }
code > span.fl { color: #d14; }
code > span.ch { color: #d14; }
code > span.st { color: #d14; }
code > span.co { color: #888888; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #900; font-weight: bold; }
code > span.er { color: #a61717; background-color: #e3d2d2; }
</style>




</head>

<body>







<style type="text/css">
h1.title {
  font-size: 38px;
  color: Black;
  text-align: center;
  padding: 15px 5px 10px 5px
}
img {
  border: none
}
</style>
<p> </p>
<h1 class="title toc-ignore">
<div class="line-block">
<p>Property Allocation Model <br /> Detailed Documentation</p>
</div>
</h1>
<p>
<center>
<img src="logo.png"/>
</center>
</p>
<center>
<p>
<strong>Author:</strong> Jimmy Briggs <a href="mailto:jimbrig1993@outlook.com" class="email">jimbrig1993@outlook.com</a>
</p>
<strong>Date:</strong> Last Compiled on March 24, 2020
</center>
<p> </p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>The purpose of this report is to walk through the various allocation procedures utilized in the shiny application.</p>
<p>In order to provide knowledgeable insights from this report, we have supplied reasonable inputs that mimic the <em>user-driven</em> aspects of the allocation procedures.</p>
<div id="setup" class="section level3">
<h3>Setup</h3>
<ul>
<li>Set Options and Configurations</li>
<li>Library Packages</li>
</ul>
<p>See <a href="#appendix-b-session-info">Appendix B: Session Info</a> for all packages utilized in this document.</p>
</div>
<div id="initial-data" class="section level3">
<h3>Initial Data</h3>
<p>The data utilized in the model is broken down into the following:</p>
<ol style="list-style-type: decimal">
<li>Schedule of Values (SOV)</li>
<li>Loss Run</li>
<li>Priors</li>
<li>Renewal Costs</li>
<li>Count Bucket Definitions</li>
<li>Market Rates</li>
<li>Model Rates</li>
<li>Relativity</li>
<li>User-Defined Experience Period</li>
<li>User-Defined Percent Capping Threshold</li>
</ol>
<p>For more detailed information on each of these data inputs, please see the <a href="data_documentation.html">Data Documentation Vignette</a>.</p>
</div>
</div>
<div id="ingest-data" class="section level2">
<h2>Ingest Data</h2>
<p>This step involves merging each user-defined input table into a single, unified <em>Entity Data</em> database. In no particular order the steps undertaken here are:</p>
<ul>
<li>Derive costs to be allocated from the renewal costs table</li>
<li>Derive relativity adjusted TIVs from relativity table</li>
<li>Merge data into a unified entity database before pushing into the model</li>
</ul>
<div id="renewal-costs-overview" class="section level3">
<h3>Renewal Costs Overview</h3>
<p>Let’s take a look at our initial renewal costs table.</p>
<p>Note that in the actual shiny application, this will be a dynamic user-input table that the user can edit and make changes to.</p>
<table class="table table-striped table-bordered table-responsive" style="margin-left: auto; margin-right: auto;">
<caption>
Initial Costs Table
</caption>
<thead>
<tr>
<th style="text-align:center;font-weight: bold;text-align: center;">
Cost Type
</th>
<th style="text-align:center;font-weight: bold;text-align: center;">
Description
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Prior
</th>
<th style="text-align:right;font-weight: bold;text-align: center;">
Current
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">
Premium
</td>
<td style="text-align:center;">
All Risk
</td>
<td style="text-align:right;">
$63,301,745
</td>
<td style="text-align:right;">
$65,200,798
</td>
</tr>
<tr>
<td style="text-align:center;">
Premium
</td>
<td style="text-align:center;">
Terrorism
</td>
<td style="text-align:right;">
$3,909,519
</td>
<td style="text-align:right;">
$4,026,804
</td>
</tr>
<tr>
<td style="text-align:center;">
Expense
</td>
<td style="text-align:center;">
Taxes
</td>
<td style="text-align:right;">
$602,831
</td>
<td style="text-align:right;">
$620,916
</td>
</tr>
<tr>
<td style="text-align:center;">
Expense
</td>
<td style="text-align:center;">
Fees
</td>
<td style="text-align:right;">
$4,645,560
</td>
<td style="text-align:right;">
$4,784,927
</td>
</tr>
<tr>
<td style="text-align:center;">
Expense
</td>
<td style="text-align:center;">
Program
</td>
<td style="text-align:right;">
$1,435,010
</td>
<td style="text-align:right;">
$1,478,060
</td>
</tr>
<tr>
<td style="text-align:center;font-weight: bold;background-color: lightgrey !important;">
Total
</td>
<td style="text-align:center;font-weight: bold;background-color: lightgrey !important;">
</td>
<td style="text-align:right;font-weight: bold;background-color: lightgrey !important;">
$73,894,665
</td>
<td style="text-align:right;font-weight: bold;background-color: lightgrey !important;">
$76,111,505
</td>
</tr>
</tbody>
</table>
<p>Note that for the above initial costs table, only the <em>Premium</em> amounts will be allocated using our model methods, while expenses are allocated based on the TIV distribution by entity.</p>
<p>The Cost Group <strong>All Risk</strong> is composed of AOP and CAT Premiums.</p>
<p>Using the initial costs table, we want to extract the following values for use in the model:</p>
<ul>
<li><strong>Terrorism Premium</strong></li>
<li><strong>All Risk Cost</strong></li>
<li><strong>Risk Transfer Cost</strong><br />
</li>
<li><strong>Expenses</strong></li>
</ul>
<hr />
<p><strong><em>Formulas:</em></strong></p>
<p><span class="math display">\[Risk\ Transfer\ Cost = All\ Risk\ Cost + Terrorism\ Premium\]</span><br />
<span class="math display">\[All\ Risk\ Cost\ = \ AOP\ Premium + CAT\ Premium\]</span><br />
<span class="math display">\[CAT\ Premium = \sum_i{CAT\ Premium_i}\\\ (where\ i = CAT\ EQ,\ CAT\ Wind,\ and\ CAT\ Flood)\]</span><br />
<span class="math display">\[Expenses = \sum_i{Expenses_i}\]</span><br />
</p>
<hr />
<p><strong><em>Notes:</em></strong></p>
<ul>
<li><p>For Terrorism Premium, if not directly input by user, can be backed into by subtracting the <em>All Risk Cost</em> from the <em>Risk Transfer Cost</em>.</p></li>
<li><p>For expenses, we take the sum of all non-premium related costs. If there are any expenses that should not be allocated in the model they should be excluded.</p></li>
</ul>
<hr />
</div>
<div id="derive-costs-to-be-allocated" class="section level3">
<h3>Derive Costs to be Allocated</h3>
<p>Now, we need to extract the <strong><em>costs to be allocated</em></strong> in the model, specifically:</p>
<ol style="list-style-type: decimal">
<li>The Total Cost Including Expenses<br />
</li>
<li>The Risk Transfer Cost<br />
</li>
<li>The All Risk Cost<br />
</li>
<li>The Sum of Expenses</li>
</ol>
<p>To do this, I utilize an internal, custom utility function .</p>
<p>The resulting <strong><em>Costs for Allocation</em></strong> are:</p>
<pre><code>#&gt; Error in extract_costs_for_allocation(initial_costs): could not find function &quot;extract_costs_for_allocation&quot;
#&gt; Error in tibble::as_tibble(costs): object &#39;costs&#39; not found</code></pre>
</div>
<div id="derive-relativity-adjusted-tivs" class="section level3">
<h3>Derive Relativity Adjusted TIVs</h3>
<p>This step involves taking the user-defined relativity’s and multiplying them by the initial <em>Total Insured Values</em> defined in the Schedule of Values (SOV).</p>
<p>Specifically, we take the user-input <em>Relativity Table</em> and apply a custom utility function <code>derive_relativity_adjusted_tivs()</code> to derive our final relativity adjusted TIVs.</p>
<p>First, lets look at the input relativities:</p>
<pre><code>#&gt; Error in tbl_vars_dispatch(x): object &#39;initial_relativities&#39; not found</code></pre>
<p>Now using <code>derive_relativity_adjusted_tivs()</code>, we get our resulting adjusted TIVs:</p>
<pre><code>#&gt; Error in derive_relativity_adjusted_tivs(bu_relativites, sprinkler_tier_relativities, : could not find function &quot;derive_relativity_adjusted_tivs&quot;
#&gt; Error in dplyr::mutate(., entity_id = toproper(entity_id)): object &#39;relativity_adjusted_tivs&#39; not found</code></pre>
<p><strong><em>NOTE: For display purposes I will only show the first 10 rows here:</em></strong></p>
</div>
<div id="ingest-count-buckets-and-loss-run" class="section level3">
<h3>Ingest Count Buckets and Loss Run</h3>
<p>The purpose of this step is to ingest the user-defined count buckets, defined in the count bucket surcharge table in order to set the <strong>Entity Data</strong> database up to properly flow into the allocation model before applying the percent and dollar surcharges to the allocated amounts.</p>
<p>In the end, we will derive final surcharge amounts by entity based off of their historical loss experience, but in order to apply these we first need our preliminary allocated premium amounts (in order to apply the percent surcharges). However, for now we need to shape the data so this process is streamlined later on.</p>
<p>The user-driven inputs utilized are:</p>
<ul>
<li>The Loss Run</li>
<li>The Count Bucket Surcharge Table’s Defined Bucket Minimum and Maximum Values<br />
</li>
<li>The User-Defined Experience Period</li>
</ul>
<p>From these we do the following to derive our desired results:</p>
<ol style="list-style-type: decimal">
<li><p>Filter the loss run to only include dates of loss within the user-defined experience period interval.</p></li>
<li><p>Filter out any claims with incurred values below the minimum specified value or above the maximum specified amount (for the first and last defined buckets, respectively).</p></li>
<li><p>Summarize the loss run into a table displaying the number of claims within<br />
each user-defined claim count severity <em>bucket</em>.</p></li>
<li><p>Derive total <strong>dollar</strong> surcharge amounts by entity (cannot apply the <strong>percent surcharges yet</strong>), by taking results from step 2 and applying the dollar amount surcharges to each entity.</p></li>
</ol>
<p>For this example I assume an experience period of: <strong>January 01, 2015 to December 31, 2019</strong>.</p>
<p>Also, I assume the following user-defined surcharge inputs:</p>
<pre><code>#&gt; Error in select(., name:dollar_surcharge): object &#39;initial_count_buckets&#39; not found</code></pre>
<p><strong>NOTES:</strong></p>
<ul>
<li><p>$0 claims are included in the first bucket, this can be changed by specifying a min value of $1 instead of $0 in the table. This will filter out $0 claims.</p></li>
<li><p>I have arranged the table in decreasing order of total incurred amount, and am only displaying the top 10 rows by entity.</p></li>
</ul>
<p>Now, lets derive and preview the aforementioned table summarizing the results by entity to be ingested into the final <strong>Entity Data</strong> database.</p>
<pre><code>#&gt; Error in derive_entity_loss_data(loss_run, initial_count_buckets, experience_period): could not find function &quot;derive_entity_loss_data&quot;
#&gt; Error in eval(expr, envir, enclos): object &#39;initial_count_buckets&#39; not found
#&gt; Error in kkable(entity_loss_data %&gt;% dplyr::mutate(entity_id = toproper(entity_id)) %&gt;% : object &#39;col_names&#39; not found</code></pre>
</div>
<div id="ingest-rates" class="section level3">
<h3>Ingest Rates</h3>
<p>This step takes the market rates, user-defined model rates, and prior rates and merges them with the entities via their respective <em>Rate ID’s</em> defined in the SOV.</p>
<p>Once we have mapped rates, relativity adjusted TIVs, and costs for allocation we are ready to begin the process of allocating premiums to individual entities.</p>
<p>Let’s preview out indicated prior rates, market rates, and the user-defined model rates for each coverage and subcoverage split:</p>
<pre><code>#&gt; Error in dplyr::mutate(., rate_type = dplyr::case_when(rate_type == &quot;aop&quot; ~ : object &#39;initial_rates&#39; not found
#&gt; Error in purrr::map2(rate_tables, names(rate_tables), function(x, y) {: object &#39;rate_tables&#39; not found</code></pre>
<p>Now we can move onto the final <strong><em>data ingestion</em></strong> process which is to form our preliminary <strong>Entity Data</strong> database to push into the model.</p>
</div>
<div id="form-entity-database" class="section level3">
<h3>Form Entity Database</h3>
<p>This step merges all previous derived data into a single unified database for use in the model. In particular it merges:</p>
<ol style="list-style-type: decimal">
<li>The SOV</li>
<li>Market Rates by Key</li>
<li>Relativity Adjusted TIVs</li>
<li>The Loss Data and Count Buckets</li>
<li>The Selected Model Rates</li>
<li>Prior Rates and Premiums</li>
</ol>
<pre><code>#&gt; Error in derive_entity_data(sov, relativity_adjusted_tivs, entity_loss_data, : could not find function &quot;derive_entity_data&quot;</code></pre>
</div>
</div>
<div id="perform-allocation" class="section level2">
<h2>Perform Allocation</h2>
<p>Now that we have ingested all of the relevant data we can begin allocating out premiums.</p>
<p>The steps are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Derive (Relativity Adjusted) Preliminary Market Premiums for each coverage group.</p></li>
<li><p>Derive (Relativity Adjusted) Preliminary Model Premiums for each coverage group.</p></li>
<li><p>Sum together all <strong><em>CAT</em></strong> premiums to get a total CAT premium across EQ, Wind, and Flood.</p></li>
<li><p>Subtract the Total CAT Premium from the <strong><em>All Risk Premium</em></strong> to derive our total <strong><em>AOP</em></strong> amount to allocate.</p></li>
<li><p>Re-balance the <em>preliminary</em> <strong><em>AOP</em></strong> derived premiums to force the total to equal the necessary amount from the previous step.</p></li>
<li><p>Sum together the Rebalanced AOP Premium, the total CAT premium, and the Terrorism Premium to get a total model premium.</p></li>
<li><p>Add the percentage and dollar surcharges by claim count bucket to the total preliminary premium.</p></li>
<li><p>Allocate expenses using the derived total expenses amount from the costs table via the percentage distribution of TIV (unadjusted) by entity.</p></li>
<li><p>Apply capping on percentage <strong><em>rate</em></strong> changes since prior.</p></li>
<li><p>Re-balance capped premiums to equal the desired cost inputs.</p></li>
<li><p>Validate Results</p></li>
<li><p>Summarize Results</p></li>
</ol>
<hr />
<p><strong><em>Formulas:</em></strong></p>
<p><span class="math display">\[Market\ Premium_c = Market\ Rate_c\ * Adjusted\ TIV_c\]</span></p>
<p><span class="math display">\[Where\ Subscript_c\ stands\ for\ coverage.\]</span></p>
<hr />
<div id="derive-preliminary-premiums-by-coverage-group" class="section level3">
<h3>Derive Preliminary Premiums by Coverage Group</h3>
<pre><code>#&gt; Error in dplyr::mutate(., market_cat_eq_premium = market_cat_eq_rate * : object &#39;entity_data&#39; not found
#&gt; Error in eval(expr, envir, enclos): object &#39;preliminary_allocation_data&#39; not found
#&gt; Error in eval(expr, envir, enclos): object &#39;preliminary_allocation_data&#39; not found
#&gt; Error in eval(expr, envir, enclos): object &#39;preliminary_allocation_data&#39; not found</code></pre>
</div>
<div id="apply-claim-count-surcharges" class="section level3">
<h3>Apply Claim Count Surcharges</h3>
<pre><code>#&gt; Error in dplyr::select(., entity_id, premium = total_model_premium_adj, : object &#39;preliminary_allocation_data&#39; not found</code></pre>
<pre><code>#&gt; Error in dplyr::left_join(., priors, by = &quot;entity_id&quot;): object &#39;surcharged_allocation_data&#39; not found</code></pre>
</div>
<div id="apply-rate-capping" class="section level3">
<h3>Apply Rate Capping</h3>
<pre><code>#&gt; Error in eval(expr, envir, enclos): object &#39;costs&#39; not found
#&gt; Error in eval(expr, envir, enclos): object &#39;curr_rate&#39; not found
#&gt; Error in filter(., new == 1): object &#39;allocation_data&#39; not found
#&gt; Error in filter(., new == 0): object &#39;allocation_data&#39; not found
#&gt; Error in mutate(., prior_allocated = prior_total_premium_excl_expense, : object &#39;allocation_data_nonnew&#39; not found
#&gt; Error in eval(expr, envir, enclos): object &#39;allocation_capped&#39; not found
#&gt; Error in eval(expr, envir, enclos): object &#39;allocation_capped&#39; not found</code></pre>
</div>
<div id="summarize-results" class="section level3">
<h3>Summarize Results</h3>
</div>
</div>
<div id="output" class="section level2">
<h2>Output</h2>
<p>And finally lets output to Excel for review:</p>
<hr />
<div id="appendix-a-code" class="section level4">
<h4>Appendix A: Code</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">comment =</span> <span class="st">&quot;#&gt;&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">eval =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">echo =</span> <span class="cn">FALSE</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">load_demo_data</span>()</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>initial_costs <span class="ot">&lt;-</span> renewal_costs</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">kkable</span>(</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> initial_costs,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">caption =</span> <span class="st">&quot;Initial Costs Table&quot;</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">proper_cols =</span> <span class="fu">c</span>(<span class="st">&quot;cost_type&quot;</span>, <span class="st">&quot;description&quot;</span>),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">currency_cols =</span> <span class="fu">c</span>(<span class="st">&quot;prior&quot;</span>, <span class="st">&quot;current&quot;</span>),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">digits =</span> <span class="dv">0</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">format_header =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">add_totals =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">format_totals =</span> <span class="cn">TRUE</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>costs <span class="ot">&lt;-</span> <span class="fu">extract_costs_for_allocation</span>(initial_costs)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>tibble<span class="sc">::</span><span class="fu">as_tibble</span>(costs) <span class="sc">%&gt;%</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">t</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">&quot;Cost Type&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">&quot;Dollar Amount&quot;</span> <span class="ot">=</span> V1) <span class="sc">%&gt;%</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kkable</span>(<span class="at">currency_cols =</span> <span class="st">&quot;Dollar Amount&quot;</span>,</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">proper_cols =</span> <span class="st">&quot;Cost Type&quot;</span>,</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">caption =</span> <span class="st">&quot;Extracted Costs for Allocation:&quot;</span>)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>initial_relativities <span class="sc">%&gt;%</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate_at</span>(dplyr<span class="sc">::</span><span class="fu">vars</span>(rate_type, relativity_type), toproper, </span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">underscore_replacement =</span> <span class="st">&quot;-&quot;</span>, <span class="at">return_as =</span> <span class="st">&quot;uppercase&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">relativity_type =</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(relativity_type),</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">relativity_type =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(relativity_type, <span class="st">&quot;Bu&quot;</span>, <span class="st">&quot;Business Unit&quot;</span>),</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(level, <span class="st">&quot;bu_&quot;</span>, <span class="st">&quot;Business Unit &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot; a&quot;</span>, <span class="st">&quot; A&quot;</span>) <span class="sc">%&gt;%</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot; b&quot;</span>, <span class="st">&quot; B&quot;</span>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kkable</span>(</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&quot;Rate Type&quot;</span>, <span class="st">&quot;Relativity Type&quot;</span>, <span class="st">&quot;Level&quot;</span>, <span class="st">&quot;Relativity Factor&quot;</span>), </span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;User-Defined Relativities&quot;</span>,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimal_cols =</span> <span class="fu">c</span>(<span class="fu">ncol</span>(initial_relativities)),</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimal_digits =</span> <span class="dv">3</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="co"># derive relativity adjusted TIVs</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>relativity_adjusted_tivs <span class="ot">&lt;-</span> <span class="fu">derive_relativity_adjusted_tivs</span>(</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>  bu_relativites,</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>  sprinkler_tier_relativities,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  combustible_relativities,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  sov</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>relativity_adjusted_tivs <span class="sc">%&gt;%</span> </span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">entity_id =</span> <span class="fu">toproper</span>(entity_id)) <span class="sc">%&gt;%</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kkable</span>(</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">&quot;Resulting Relativty Adjusted Total Insured Values by Entity and Coverage: &quot;</span>,</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&quot;Entity ID&quot;</span>, <span class="st">&quot;TIV&quot;</span>, <span class="st">&quot;AOP&quot;</span>, <span class="st">&quot;CAT-EQ&quot;</span>, <span class="st">&quot;CAT-Wind&quot;</span>, <span class="st">&quot;CAT-Flood&quot;</span>, <span class="st">&quot;Terrorism&quot;</span>),</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">currency_cols =</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(relativity_adjusted_tivs))</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">add_header_above</span>(</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">header =</span> <span class="fu">c</span>(<span class="st">&quot; &quot;</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">&quot;Relativity Adjusted Total Insured Values&quot;</span> <span class="ot">=</span> <span class="dv">5</span>), </span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">bold =</span> <span class="cn">TRUE</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>min_year <span class="ot">&lt;-</span> <span class="fu">min</span>(loss_run<span class="sc">$</span>year)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>max_year <span class="ot">&lt;-</span> <span class="fu">max</span>(loss_run<span class="sc">$</span>year)</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>experience_period <span class="ot">&lt;-</span> <span class="fu">c</span>(min_year<span class="sc">:</span>max_year)</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>experience_period_display <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>   lubridate<span class="sc">::</span><span class="fu">ymd</span>(<span class="fu">paste0</span>(min_year, <span class="st">&quot;-01-01&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">format</span>(<span class="st">&quot;%B %d, %Y&quot;</span>), <span class="st">&quot; to &quot;</span>,</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>   lubridate<span class="sc">::</span><span class="fu">ymd</span>(<span class="fu">paste0</span>(max_year, <span class="st">&quot;-12-31&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">format</span>(<span class="st">&quot;%B %d, %Y&quot;</span>)</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="co"># min_value &lt;- min(initial_count_buckets$min)</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="co"># max_value &lt;- max(initial_count_buckets$max)</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>initial_count_buckets <span class="sc">%&gt;%</span></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name<span class="sc">:</span>dollar_surcharge) <span class="sc">%&gt;%</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kkable</span>(</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&quot;Label&quot;</span>, <span class="st">&quot;Minimum&quot;</span>, <span class="st">&quot;Maximum&quot;</span>, <span class="st">&quot;Percent Surcharge&quot;</span>, <span class="st">&quot;Dollar Surcharge&quot;</span>),</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>     <span class="at">caption =</span> <span class="st">&quot;User-Defined Claim Count Bucket Surcharges&quot;</span>,</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">currency_cols =</span> <span class="fu">c</span>(<span class="st">&quot;min&quot;</span>, <span class="st">&quot;max&quot;</span>, <span class="st">&quot;dollar_surcharge&quot;</span>),</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_cols =</span> <span class="fu">c</span>(<span class="st">&quot;percent_surcharge&quot;</span>)</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>entity_loss_data <span class="ot">&lt;-</span> <span class="fu">derive_entity_loss_data</span>(loss_run, initial_count_buckets, experience_period)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>col_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Entity ID&quot;</span>, </span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>               initial_count_buckets<span class="sc">$</span>name,</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>               <span class="st">&quot;Total Counts&quot;</span>, <span class="st">&quot;Total Incurred&quot;</span>)</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a><span class="fu">kkable</span>(entity_loss_data <span class="sc">%&gt;%</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>         dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">entity_id =</span> <span class="fu">toproper</span>(entity_id)) <span class="sc">%&gt;%</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>         dplyr<span class="sc">::</span><span class="fu">arrange</span>(<span class="fu">desc</span>(total_incurred)) <span class="sc">%&gt;%</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>         <span class="fu">head</span>(<span class="dv">10</span>), </span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>       <span class="at">col_names =</span> col_names,</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>       <span class="at">currency_cols =</span> <span class="fu">length</span>(col_names),</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Summarized Loss Data by Entity (Top 10 Entities by Total Incurred)&quot;</span>)</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>rate_tables <span class="ot">&lt;-</span> initial_rates <span class="sc">%&gt;%</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rate_type =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>    rate_type <span class="sc">==</span> <span class="st">&quot;aop&quot;</span> <span class="sc">~</span> <span class="st">&quot;AOP&quot;</span>,</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>    rate_type <span class="sc">==</span> <span class="st">&quot;cat_eq&quot;</span> <span class="sc">~</span> <span class="st">&quot;CAT-EQ&quot;</span>,</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>    rate_type <span class="sc">==</span> <span class="st">&quot;cat_wind&quot;</span> <span class="sc">~</span> <span class="st">&quot;CAT-Wind&quot;</span>,</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>    rate_type <span class="sc">==</span> <span class="st">&quot;cat_flood&quot;</span> <span class="sc">~</span> <span class="st">&quot;CAT-Flood&quot;</span>,</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>    rate_type <span class="sc">==</span> <span class="st">&quot;terror&quot;</span> <span class="sc">~</span> <span class="st">&quot;Terrorism&quot;</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(initial_rates<span class="sc">$</span>rate_type) <span class="sc">%&gt;%</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">set_names</span>(<span class="fu">c</span>(<span class="st">&quot;All Other Peril (AOP)&quot;</span>,</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;Catastrophe - Earthquake (CAT-EQ)&quot;</span>,</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;Catastrophe - Wind (CAT-Wind)&quot;</span>,</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;Catastrophe - Flood (CAT-Flood)&quot;</span>,</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&quot;Terrorism&quot;</span>))</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map2</span>(rate_tables, <span class="fu">names</span>(rate_tables), <span class="cf">function</span>(x, y) {</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>   <span class="fu">kable</span>(</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>     x,</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>     <span class="at">row.names =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>     <span class="at">digits =</span> <span class="dv">3</span>, </span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>     <span class="at">align =</span> <span class="st">&quot;crrrcc&quot;</span>,</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>     <span class="at">col.names =</span> snakecase<span class="sc">::</span><span class="fu">to_mixed_case</span>(<span class="fu">names</span>(x), <span class="at">sep_out =</span> <span class="st">&quot; &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>       stringr<span class="sc">::</span><span class="fu">str_to_title</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>       stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;Tiv&quot;</span>, <span class="st">&quot;TIV&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>       stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;Id&quot;</span>, <span class="st">&quot;ID&quot;</span>),</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>     <span class="at">caption =</span> <span class="fu">paste0</span>(y, <span class="st">&quot; - Rates&quot;</span>),</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>     <span class="at">format.args =</span> <span class="fu">list</span>(<span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>)</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>   ) <span class="sc">%&gt;%</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>     kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">position =</span> <span class="st">&quot;center&quot;</span>,</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">&quot;striped&quot;</span>, <span class="st">&quot;bordered&quot;</span>, <span class="st">&quot;condensed&quot;</span>, <span class="st">&quot;responsive&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>     kableExtra<span class="sc">::</span><span class="fu">row_spec</span>(<span class="at">row =</span> <span class="dv">0</span>, <span class="at">bold =</span> <span class="cn">TRUE</span>, <span class="at">align =</span> <span class="st">&quot;center&quot;</span>)</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a> }) <span class="sc">%&gt;%</span> <span class="fu">set_names</span>(<span class="cn">NULL</span>) <span class="sc">%&gt;%</span> purrr<span class="sc">::</span><span class="fu">walk</span>(print)</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>entity_data <span class="ot">&lt;-</span> <span class="fu">derive_entity_data</span>(sov, relativity_adjusted_tivs, entity_loss_data, initial_rates)</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="co"># names(entity_data)</span></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>preliminary_allocation_data <span class="ot">&lt;-</span> <span class="fu">preliminary_allocation</span>(entity_data)</span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="co"># checks</span></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(preliminary_allocation_data<span class="sc">$</span>rebalanced_model_terrorism_premium_adj) <span class="sc">==</span> costs<span class="sc">$</span>terrorism</span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(preliminary_allocation_data<span class="sc">$</span>total_model_premium_adj) <span class="sc">==</span> costs<span class="sc">$</span>risk_transfer</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(preliminary_allocation_data<span class="sc">$</span>rebalanced_model_aop_premium_adj, preliminary_allocation_data<span class="sc">$</span>total_model_cat_premium_adj) <span class="sc">==</span> costs<span class="sc">$</span>all_risk</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>surcharged_allocation_data <span class="ot">&lt;-</span> <span class="fu">apply_surcharges</span>(preliminary_allocation_data, initial_count_buckets)</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>allocation_data <span class="ot">&lt;-</span> surcharged_allocation_data <span class="sc">%&gt;%</span></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(priors, <span class="at">by =</span> <span class="st">&quot;entity_id&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">new =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(prior_tiv) <span class="sc">|</span> prior_tiv <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>curr_rate <span class="ot">&lt;-</span> costs<span class="sc">$</span>risk_transfer <span class="sc">/</span> <span class="fu">sum</span>(sov<span class="sc">$</span>tiv)</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>prior_rate <span class="ot">&lt;-</span> <span class="fu">sum</span>(priors<span class="sc">$</span>prior_total_premium_excl_expense) <span class="sc">/</span> </span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(priors<span class="sc">$</span>prior_tiv)</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>pct_change <span class="ot">&lt;-</span> (curr_rate <span class="sc">/</span> prior_rate) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>new_ents <span class="ot">&lt;-</span> allocation_data <span class="sc">%&gt;%</span></span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(new <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>allocation_data_nonnew <span class="ot">&lt;-</span> allocation_data <span class="sc">%&gt;%</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(new <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>allocation_capped <span class="ot">&lt;-</span> allocation_data_nonnew <span class="sc">%&gt;%</span></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prior_allocated =</span> prior_total_premium_excl_expense,</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>         <span class="at">prior_allocated_rate =</span> prior_allocated <span class="sc">/</span> prior_tiv,</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>         <span class="at">uncapped_allocated =</span> surcharged_premium) <span class="sc">%&gt;%</span></span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply_threshold</span>(<span class="at">total_pct_chg =</span> pct_change,</span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>                  <span class="at">threshold =</span> .<span class="dv">25</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(new_ents) <span class="sc">%&gt;%</span></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>    <span class="at">allocated =</span> <span class="fu">coalesce</span>(allocated, surcharged_premium),</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_tiv =</span> tiv <span class="sc">/</span> <span class="fu">sum</span>(tiv),</span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">allocated_pct =</span> allocated <span class="sc">/</span> <span class="fu">sum</span>(allocated, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>    <span class="at">rebalanced_allocated =</span> allocated_pct <span class="sc">*</span> costs<span class="sc">$</span>risk_transfer,</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>    <span class="co"># allocated_expenses = percent_tiv * curr_expenses,</span></span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">final_allocated_w_expense =</span> rebalanced_allocated <span class="sc">+</span> allocated_expense</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(allocation_capped<span class="sc">$</span>final_allocated_w_expense) <span class="sc">==</span> costs<span class="sc">$</span>risk_transfer <span class="sc">+</span> costs<span class="sc">$</span>expenses</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(allocation_capped<span class="sc">$</span>final_allocated_w_expense) <span class="sc">==</span> costs<span class="sc">$</span>total_incl_expense</span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a><span class="co"># allocation_summary &lt;- allocation_capped %&gt;%</span></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a><span class="co">#   dplyr::transmute(</span></span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a><span class="co">#     entity_id = entity_id,</span></span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a><span class="co">#     bu = bu,</span></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a><span class="co">#     region = region,</span></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a><span class="co">#     country = country,</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a><span class="co">#     division = division,</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="co">#     location = location,</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a><span class="co">#     department = department,</span></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a><span class="co">#     tiv = tiv,</span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_aop_rate = model_aop_rate,</span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_cat_rate = total_model_cat_premium_adj / tiv,</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_all_risk_rate = initial_aop_rate + initial_cat_rate,</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_all_risk_premium = tiv * initial_all_risk_rate,</span></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_terrorism_rate = model_terrorism_rate,</span></span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_terrorism_premium = initial_terrorism_rate * tiv,</span></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_premium_excl_expenses = initial_all_risk_premium + initial_terrorism_premium,</span></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a><span class="co">#     market_premium_rate = market_aop_rate + market_cat_eq_rate + market_cat_flood_rate + market_cat_wind_rate + market_terrorism_rate,</span></span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a><span class="co">#     market_premium_excl_expense = market_premium_rate * tiv,</span></span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a><span class="co">#     prior_premium_excl_expense = prior_total_premium_excl_expense,</span></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_pct_change_from_market_premium_excl_expense = ifelse(</span></span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a><span class="co">#       is.na(market_premium_excl_expense) | market_premium_excl_expense == 0, </span></span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a><span class="co">#       NA, (initial_premium_excl_expenses / market_premium_excl_expense) - 1),</span></span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a><span class="co">#     initial_pct_change_from_prior_premium_excl_expense = ifelse(</span></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a><span class="co">#       is.na(prior_total_premium_excl_expense) | </span></span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a><span class="co">#         prior_total_premium_excl_expense == 0, </span></span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a><span class="co">#       NA, (initial_premium_excl_expenses / prior_total_premium_excl_expense) - 1),</span></span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a><span class="co">#     surcharged_premium,</span></span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a><span class="co">#     capped_surcharged_premium = rebalanced_allocated,</span></span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_premium_w_expense = final_allocated_w_expense,</span></span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_market_premium_w_expense = market_premium_excl_expense + allocated_expense,</span></span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_pct_change_from_market = (final_premium_w_expense / final_market_premium_w_expense) - 1,</span></span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_dollar_change_from_market = final_premium_w_expense - final_market_premium_w_expense,</span></span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_prior_premium_w_expense = prior_total_premium_incl_expense,</span></span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_pct_change_from_prior = (final_premium_w_expense / final_prior_premium_w_expense) - 1,</span></span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_dollar_change_from_market = final_premium_w_expense - final_prior_premium_w_expense,</span></span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_pct_change_from_initial_premium = (final_premium_w_expense / initial_premium_excl_expenses) - 1,</span></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_dollar_change_from_initial_premium = final_premium_w_expense - initial_premium_excl_expenses,</span></span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a><span class="co">#     model_aop_id = model_aop_id,</span></span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a><span class="co">#     aop_sprinkler_tier = aop_sprinkler_tier,</span></span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a><span class="co">#     aop_combustible = aop_combustible,</span></span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a><span class="co">#     aop_relativity = aop_adj_tiv / tiv,</span></span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a><span class="co">#     aop_adj_tiv = aop_adj_tiv,</span></span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a><span class="co">#     model_cat_eq_id = model_cat_eq_id,</span></span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_eq_adj_tiv = cat_eq_adj_tiv,</span></span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_eq_relativity = cat_eq_adj_tiv / tiv,</span></span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_eq_adj_tiv = cat_eq_adj_tiv,</span></span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a><span class="co">#     model_cat_wind_id = model_cat_wind_id,</span></span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_wind_adj_tiv = cat_wind_adj_tiv,</span></span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_wind_relativity = cat_eq_adj_tiv / tiv,</span></span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_wind_adj_tiv = cat_wind_adj_tiv,</span></span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a><span class="co">#     model_cat_flood_id = model_cat_flood_id,</span></span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_flood_adj_tiv = cat_flood_adj_tiv,</span></span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_flood_relativity = cat_flood_adj_tiv / tiv,</span></span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat_flood_adj_tiv = cat_flood_adj_tiv,</span></span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a><span class="co">#     model_terrorism_id = model_terrorism_id,</span></span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a><span class="co">#     terrorism_adj_tiv = terrorism_adj_tiv,</span></span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a><span class="co">#     terrorism_relativity = terrorism_adj_tiv / tiv,</span></span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a><span class="co">#     terrorism_adj_tiv = terrorism_adj_tiv</span></span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a><span class="co"># output_dir &lt;- fs::path(here::here(), &quot;outputs&quot;)</span></span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a><span class="co"># fs::dir_create(output_dir)</span></span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a><span class="co"># writexl::write_xlsx(allocation_summary, fs::path(output_dir, &quot;Allocation-Summary-v2.xlsx&quot;))</span></span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a><span class="co"># outputs &lt;- list(</span></span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Allocation Working&quot; = allocation_capped,</span></span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a><span class="co">#   # premium_tables,</span></span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;AOP&quot; = aop_premiums %&gt;% select(-entities),</span></span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;CAT&quot; = cat_premiums %&gt;% select(-entities),</span></span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Terror&quot; = terror_premiums %&gt;% select(-entities),</span></span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Count Bucket Surcharges&quot; = bucket_summary,</span></span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Initial Costs&quot; = initial_costs,</span></span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Initial Entity Data&quot; = entity_data,</span></span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Initial Rates&quot; = initial_rates,</span></span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Initial Premiums&quot; = initial_premiums,</span></span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;SOV&quot; = sov,</span></span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a><span class="co">#   &quot;Priors&quot; = priors</span></span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb12-251"><a href="#cb12-251" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb12-252"><a href="#cb12-252" aria-hidden="true" tabindex="-1"></a><span class="co"># writexl::write_xlsx(outputs, fs::path(output_dir, &quot;Results.xlsx&quot;))</span></span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code></pre></div>
<hr />
</div>
<div id="appendix-b-session-info" class="section level4">
<h4>Appendix B: Session Info</h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R version 4.0.3 (2020-10-10)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Platform: x86_64-w64-mingw32/x64 (64-bit)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Running under: Windows 10 x64 (build 20262)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; locale:</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] LC_COLLATE=English_United States.1252 </span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2] LC_CTYPE=English_United States.1252   </span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3] LC_MONETARY=English_United States.1252</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [4] LC_NUMERIC=C                          </span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [5] LC_TIME=English_United States.1252    </span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; other attached packages:</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] lubridate_1.7.9.2   readr_1.4.0         tidyr_1.1.2        </span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [4] tidyselect_1.1.0    rlang_0.4.8         stringr_1.4.0      </span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [7] formattable_0.2.0.1 kableExtra_1.3.1    janitor_2.0.1      </span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [10] rmarkdown_2.5       knitr_1.30          dplyr_1.0.2        </span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] purrr_0.3.4         fs_1.5.0            qs_0.23.3          </span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [16] propalloc_1.1.0    </span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] xts_0.12.1              usethis_1.6.3           webshot_0.5.2          </span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [4] httr_1.4.2              rprojroot_2.0.2         tools_4.0.3            </span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [7] backports_1.2.0         R6_2.5.0                DT_0.16                </span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [10] colorspace_2.0-0        shinycustomloader_0.9.0 withr_2.3.0            </span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] curl_4.3                compiler_4.0.3          cli_2.1.0              </span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [16] rvest_0.3.6             xml2_1.3.2              shinyjs_2.0.0          </span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [19] desc_1.2.0              rhandsontable_0.3.7     stringfish_0.14.2      </span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [22] matchmaker_0.1.1        scales_1.1.1            digest_0.6.27          </span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [25] pkgconfig_2.0.3         htmltools_0.5.0         highcharter_0.8.2      </span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [28] attempt_0.3.1           highr_0.8               fastmap_1.0.1          </span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [31] htmlwidgets_1.5.2       TTR_0.24.2              rstudioapi_0.13        </span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [34] quantmod_0.4.17         shiny_1.5.0             generics_0.1.0         </span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [37] RApiSerialize_0.1.0     zoo_1.8-8               jsonlite_1.7.1         </span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [40] config_0.3              magrittr_2.0.1          rlist_0.4.6.1          </span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [43] Rcpp_1.0.5              munsell_0.5.0           fansi_0.4.1            </span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [46] lifecycle_0.2.0         stringi_1.5.3           yaml_2.2.1             </span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [49] rintrojs_0.2.2          snakecase_0.11.0        grid_4.0.3             </span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [52] promises_1.1.1          shinydashboard_0.7.1    forcats_0.5.0          </span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [55] crayon_1.3.4            lattice_0.20-41         hms_0.5.3              </span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [58] pillar_1.4.6            igraph_1.2.6            pkgload_1.1.0          </span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [61] glue_1.4.2              evaluate_0.14           golem_0.2.1            </span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [64] data.table_1.13.2       remotes_2.2.0           RcppParallel_5.0.2     </span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [67] vctrs_0.3.5             httpuv_1.5.4            testthat_3.0.0         </span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [70] assertthat_0.2.1        xfun_0.19               mime_0.9               </span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [73] xtable_1.8-4            broom_0.7.2             roxygen2_7.1.1         </span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [76] later_1.1.0.1           viridisLite_0.3.0       dockerfiler_0.1.3      </span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [79] tibble_3.0.4            writexl_1.3.1           shinyWidgets_0.5.4     </span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [82] ellipsis_0.3.1</span></span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
