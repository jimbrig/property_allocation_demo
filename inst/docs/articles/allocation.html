<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Allocation Walkthrough • propalloc</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Allocation Walkthrough">
<meta property="og:description" content="propalloc">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">propalloc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/allocation.html">Allocation Walkthrough</a>
    </li>
    <li>
      <a href="../articles/package-api.html">Package API</a>
    </li>
    <li>
      <a href="../articles/setup.html">Property Allocation Shiny App Setup Guide</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jimbrig/propalloc/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="allocation_files/header-attrs-2.3/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Allocation Walkthrough</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jimbrig/propalloc/blob/master/vignettes/allocation.Rmd"><code>vignettes/allocation.Rmd</code></a></small>
      <div class="hidden name"><code>allocation.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The purpose of this report is to walk through the various allocation procedures utilized in the shiny application.</p>
<p>In order to provide knowledgeable insights from this report, we have supplied reasonable inputs that mimic the <em>user-driven</em> aspects of the allocation procedures.</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>The first step is to ingest all of the various user-driven inputs and demo-data to form a dataset to perform the allocation with.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="../reference/load_demo_data.html">load_demo_data</a></span>()</pre></body></html></div>
<p>Specify various ‘user-defined’ inputs:</p>
<ul>
<li>Experience Period for Loss Run</li>
<li>Capping Threshold (%)</li>
<li>Budget guidance increase factor (a % applied to prior rates which are then used to allocate premiums)</li>
</ul>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># specify experience period based on loss run</span>
<span class="no">min_year</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">loss_run</span>$<span class="no">year</span>)
<span class="no">max_year</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">loss_run</span>$<span class="no">year</span>)
<span class="no">experience_period</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">min_year</span>:<span class="no">max_year</span>)

<span class="no">experience_period_display</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(
  <span class="kw pkg">lubridate</span><span class="kw ns">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">min_year</span>, <span class="st">"-01-01"</span>)) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="st">"%B %d, %Y"</span>), <span class="st">" to "</span>,
  <span class="kw pkg">lubridate</span><span class="kw ns">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">max_year</span>, <span class="st">"-12-31"</span>)) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span>(<span class="st">"%B %d, %Y"</span>)
)

<span class="co"># specify percent change capping threshold</span>
<span class="no">cap_threshold</span> <span class="kw">&lt;-</span> <span class="fl">.25</span>

<span class="co"># A 5% budget guidance increase factor</span>
<span class="no">budget_guidance_percent</span> <span class="kw">&lt;-</span> <span class="fl">0.05</span></pre></body></html></div>
<div id="costs-to-be-allocated" class="section level3">
<h3 class="hasAnchor">
<a href="#costs-to-be-allocated" class="anchor"></a>Costs to be Allocated</h3>
<p>we need to extract the <strong><em>costs to be allocated</em></strong> in the model, specifically:</p>
<ol style="list-style-type: decimal">
<li>The Total Cost Including Expenses<br>
</li>
<li>The Risk Transfer Cost<br>
</li>
<li>The All Risk Cost<br>
</li>
<li>The Sum of Expenses</li>
</ol>
<p>To do this, I utilize an internal, custom utility function <code>extract_costs_for_allocation()</code>.</p>
<p>The resulting <strong><em>Costs for Allocation</em></strong> are:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># extract costs from renewal cost table</span>
<span class="no">costs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/extract_costs.html">extract_costs</a></span>(<span class="no">renewal_costs</span>)

<span class="co"># derive current and prior overall rates and percent change</span>
<span class="no">curr_rate</span> <span class="kw">&lt;-</span> <span class="no">costs</span>$<span class="no">risk_transfer</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">sov</span>$<span class="no">tiv</span>)
<span class="no">prior_rate</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">priors</span>$<span class="no">prior_risk_transfer_premium</span>) /
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">priors</span>$<span class="no">prior_tiv</span>)
<span class="no">pct_change</span> <span class="kw">&lt;-</span> (<span class="no">curr_rate</span> / <span class="no">prior_rate</span>) - <span class="fl">1</span>

<span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span>(<span class="no">costs</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames_to_column</a></span>(<span class="kw">var</span> <span class="kw">=</span> <span class="st">"Cost Type"</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span>(<span class="st">"Dollar Amount"</span> <span class="kw">=</span> <span class="no">V1</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/kkable.html">kkable</a></span>(<span class="kw">currency_cols</span> <span class="kw">=</span> <span class="st">"Dollar Amount"</span>,
         <span class="kw">proper_cols</span> <span class="kw">=</span> <span class="st">"Cost Type"</span>,
         <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"Extracted Costs for Allocation:"</span>)</pre></body></html></div>
</div>
<div id="derive-relativity-adjusted-tivs" class="section level3">
<h3 class="hasAnchor">
<a href="#derive-relativity-adjusted-tivs" class="anchor"></a>Derive Relativity Adjusted TIVs</h3>
<p>This step involves taking the user-defined relativity’s and multiplying them by the initial <em>Total Insured Values</em> defined in the Schedule of Values (SOV).</p>
<p>Specifically, we take the user-input <em>Relativity Table</em> and apply a custom utility function <code>derive_relativity_adjusted_tivs()</code> to derive our final relativity adjusted TIVs.</p>
<p>First, lets look at the input relativities:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">rel_tables</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">bu_rels</span>, <span class="no">combustible_rels</span>, <span class="no">sprinkler_tier_rels</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/set_names.html">set_names</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Business Unit Relativity"</span>,
                     <span class="st">"AOP Combustible Relativity"</span>,
                     <span class="st">"AOP Sprinkler Tier Relativity"</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="no">apply_labels</span>, <span class="kw">dict</span> <span class="kw">=</span> <span class="no">dictionary</span>, <span class="kw">dataset_name</span> <span class="kw">=</span> <span class="st">"rels"</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="no"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span>)

<span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span>(<span class="no">rel_tables</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">rel_tables</span>), <span class="kw">function</span>(<span class="no">x</span>, <span class="no">y</span>) {
  <span class="fu"><a href="../reference/kkable.html">kkable</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">caption</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">col_names</span> <span class="kw">=</span> <span class="kw">NULL</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">3</span>, <span class="kw">add_digits</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
})</pre></body></html></div>
</div>
<div id="apply-relativity-factors-to-tivs" class="section level3">
<h3 class="hasAnchor">
<a href="#apply-relativity-factors-to-tivs" class="anchor"></a>Apply relativity factors to TIVs</h3>
<p>Relativities are then applied directly to each entity’s TIV. For each relativity type, a separate relativity-adjusted TIV is calculated and used as required in eithe catastrophy allocation, All Other Peril allocation, or terrorism allocation.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">rels_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">relativity_data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="no">bu_rels</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>)], <span class="no">bu_rels</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">3</span>)], <span class="no">bu_rels</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">4</span>)], <span class="no">bu_rels</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">5</span>)],
      <span class="no">bu_rels</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">6</span>)], <span class="no">sprinkler_tier_rels</span>, <span class="no">combustible_rels</span>
    ),
    <span class="kw">coverage</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="st">"aop"</span>, <span class="st">"cat_eq"</span>, <span class="st">"cat_wind"</span>, <span class="st">"cat_flood"</span>, <span class="st">"terrorism"</span>, <span class="st">"aop"</span>, <span class="st">"aop"</span>
    ),
    <span class="kw">sov_linker</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="st">"bu"</span>, <span class="st">"bu"</span>, <span class="st">"bu"</span>, <span class="st">"bu"</span>, <span class="st">"bu"</span>, <span class="st">"aop_sprinkler_tier"</span>, <span class="st">"aop_combustible"</span>
    )
  )

<span class="no">rel_adjusted_tivs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ingest_relativities.html">ingest_relativities</a></span>(<span class="no">rels_list</span>, <span class="kw">sov</span> <span class="kw">=</span> <span class="no">sov</span>)

<span class="fu"><a href="../reference/kkable.html">kkable</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">rel_adjusted_tivs</span>),
       <span class="kw">proper_cols</span> <span class="kw">=</span> <span class="st">"entity_id"</span>,
       <span class="kw">currency_cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">rel_adjusted_tivs</span>[<span class="fl">2</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">rel_adjusted_tivs</span>)]))</pre></body></html></div>
</div>
<div id="prepare-claim-surcharges" class="section level3">
<h3 class="hasAnchor">
<a href="#prepare-claim-surcharges" class="anchor"></a>Prepare claim surcharges</h3>
<p>For entities that have experienced claims, the client may wish to increase their allocated premium. The rules for doing so are limited in this application to: applying a % surcharge to the TIV for each claim made by the entity in a certain time period, or adding a $ surcharge to the allocated premium (at this stage in the calculation) for each claim made in a certain time period.</p>
<p>The demo data, <code>count_buckets</code>, sets out a typical specification for such functionality.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">count_buckets</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">name</span>:<span class="no">dollar_surcharge</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/kkable.html">kkable</a></span>(
    <span class="kw">col_names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Label"</span>, <span class="st">"Minimum"</span>, <span class="st">"Maximum"</span>, <span class="st">"Percent Surcharge"</span>, <span class="st">"Dollar Surcharge"</span>),
    <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"User-Defined Claim Count Bucket Surcharges"</span>,
    <span class="kw">currency_cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"min"</span>, <span class="st">"max"</span>, <span class="st">"dollar_surcharge"</span>),
    <span class="kw">percent_cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"percent_surcharge"</span>)
  )</pre></body></html></div>
<p>Here, <code>count_buckets</code> are applied to the loss run ready for surcharging the premiums calculated in the main part of the model:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">entity_loss_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/entity_loss_summary.html">entity_loss_summary</a></span>(<span class="no">loss_run</span>, <span class="no">count_buckets</span>, <span class="no">experience_period</span>)

<span class="no">col_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Entity ID"</span>,
               <span class="no">count_buckets</span>$<span class="no">name</span>,
               <span class="st">"Total Counts"</span>, <span class="st">"Total Incurred"</span>)

<span class="fu"><a href="../reference/kkable.html">kkable</a></span>(<span class="no">entity_loss_data</span> <span class="kw">%&gt;%</span>
         <span class="co"># dplyr::mutate(entity_id = toproper(entity_id)) %&gt;%</span>
         <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(<span class="no">total_incurred</span>)) <span class="kw">%&gt;%</span>
         <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fl">10</span>),
       <span class="kw">col_names</span> <span class="kw">=</span> <span class="no">col_names</span>,
       <span class="kw">proper_cols</span> <span class="kw">=</span> <span class="st">"entity_id"</span>,
       <span class="kw">currency_cols</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">col_names</span>),
       <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"Summarized Loss Data by Entity (Top 10 Entities by Total Incurred)"</span>)</pre></body></html></div>
</div>
<div id="putting-it-all-together" class="section level3">
<h3 class="hasAnchor">
<a href="#putting-it-all-together" class="anchor"></a>Putting it all together</h3>
<p>The steps involved are:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/merge_entity_data.html">merge_entity_data()</a></code>:</li>
</ol>
<ul>
<li>Apply <code>rates</code> to <code>relativity_adjusted_tivs</code> and also to <code>priors</code> (to simultaneously obtain an allocation of prior premiums)</li>
<li>Apply <code>entity_loss_data</code> to surcharge the resulting premiums pased on <code>count_buckets</code> and the loss run experience</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>
<code><a href="../reference/preliminary_allocation.html">preliminary_allocation()</a></code>:</li>
</ol>
<ul>
<li>Determine a preliminary allocation of premiums (post claim surcharges) by calibrating the total allocated premium to match those indicated in <code>costs</code>
</li>
<li>Also, apply <code>budget_guidance_percent</code> to prior premium rates to perform this allocation scenario</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>
<code><a href="../reference/apply_threshold.html">apply_threshold()</a></code>:</li>
</ol>
<ul>
<li>Take the preliminary allocation of premiums and enforce a threshold upon them which prevents premiums allocated in the current period deviating too far from premium allocations of the prior period. For example, if the threshold is set to 25% (<code>threshold &lt;- 0.25</code>), and if the prior premium allocated for a particular entity was 1m USD, then roughly the current premium allocation would be between 750k USD, and 1.25m USD.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Perform final calculations to include expenses in the allocation.</li>
</ol>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># merge entity data (sov, rel adjusted tivs, loss data, market and model rates,</span>
<span class="co"># and priors)</span>

<span class="no">allocation_data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/merge_entity_data.html">merge_entity_data</a></span>(
  <span class="no">sov</span>,
  <span class="no">rel_adjusted_tivs</span>,
  <span class="no">entity_loss_data</span>,
  <span class="no">rates</span>,
  <span class="no">priors</span>
) <span class="kw">%&gt;%</span>
  <span class="co"># perform initial preliminary allocation (CAT first, back into AOP, terror)</span>
  <span class="co"># this is uncapped. before surcharges, and excluding expenses</span>
  <span class="fu"><a href="../reference/preliminary_allocation.html">preliminary_allocation</a></span>(<span class="no">costs</span>, <span class="no">budget_guidance_percent</span>) <span class="kw">%&gt;%</span>
  <span class="co"># apply surcharges</span>
  <span class="fu"><a href="../reference/apply_surcharges.html">apply_surcharges</a></span>(<span class="no">count_buckets</span>) <span class="kw">%&gt;%</span>
  <span class="co"># adjust column names for apply threshold function</span>
  <span class="co"># TODO: add arguments to apply threshold functions for specifying column</span>
  <span class="co"># so don't have to add this step.</span>
  <span class="fu">mutate</span>(
    <span class="kw">prior_allocated</span> <span class="kw">=</span> <span class="no">prior_risk_transfer_premium</span>,
    <span class="kw">prior_allocated_rate</span> <span class="kw">=</span> <span class="no">prior_allocated</span> / <span class="no">prior_tiv</span>,
    <span class="kw">uncapped_allocated</span> <span class="kw">=</span> <span class="no">surcharged_premium</span>
  ) <span class="kw">%&gt;%</span>
  <span class="co"># apply capping using a default 25% threshold</span>
  <span class="co"># TODO: add argument to apply threshold for whether or not to net the</span>
  <span class="co"># total pct change or not - currently it does this</span>
  <span class="fu"><a href="../reference/apply_threshold.html">apply_threshold</a></span>(
    <span class="kw">total_pct_chg</span> <span class="kw">=</span> <span class="no">pct_change</span>,
    <span class="kw">threshold</span> <span class="kw">=</span> <span class="no">cap_threshold</span>
  ) <span class="kw">%&gt;%</span>
  <span class="co"># final rebalancing and allocate expenses</span>
  <span class="fu"><a href="../reference/allocate_expenses.html">allocate_expenses</a></span>(<span class="no">costs</span>, <span class="kw">weight_variable</span> <span class="kw">=</span> <span class="st">"tiv"</span>)</pre></body></html></div>
<p>And the result is:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># declutter results and output</span>
<span class="no">allocation_data</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">current_allocated_rate</span> <span class="kw">=</span> <span class="no">rebalanced_allocated</span> / <span class="no">tiv</span>) <span class="kw">%&gt;%</span> <span class="co"># excl expense</span>
  <span class="fu">select</span>(
    <span class="no">entity_id</span>,
    <span class="no">tiv</span>,
    <span class="no">prior_tiv</span>,
    <span class="no">aop_adj_tiv</span>:<span class="no">terrorism_adj_tiv</span>,
    <span class="no">model_aop_rate</span>,
    <span class="no">model_cat_eq_rate</span>,
    <span class="no">model_cat_wind_rate</span>,
    <span class="no">model_cat_flood_rate</span>,
    <span class="no">model_terrorism_rate</span>,
    <span class="no">prior_risk_transfer_premium</span>,
    <span class="kw">preliminary_model_premium</span> <span class="kw">=</span> <span class="no">total_model_premium_adj</span>,
    <span class="no">surcharge</span>,
    <span class="no">surcharged_premium</span>,
    <span class="no">prior_allocated</span>,
    <span class="no">prior_allocated_rate</span>,
    <span class="no">uncapped_allocated</span>,
    <span class="kw">capped_allocated</span> <span class="kw">=</span> <span class="no">allocated</span>,
    <span class="kw">final_allocated</span> <span class="kw">=</span> <span class="no">rebalanced_allocated</span>,
    <span class="no">current_allocated_rate</span>,
    <span class="kw">rate_percent_change</span> <span class="kw">=</span> <span class="no">capped_rate_percent_change</span>,
    <span class="no">allocated_expenses</span>,
    <span class="no">final_allocated_w_expense</span>
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/kkable.html">kkable</a></span>()</pre></body></html></div>
</div>
<div id="driver-summary" class="section level3">
<h3 class="hasAnchor">
<a href="#driver-summary" class="anchor"></a>Driver Summary</h3>
<p><code>propalloc</code> comes with functionality to split out the effects of each of the stages of premium allocation as they contribute to its change between prior and current premium allocations. This function uses argument <code>filter_vector</code> to show such a split for a subset of entities if desired.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">driver_summary</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prepare_driver_summary.html">prepare_driver_summary</a></span>(<span class="no">allocation_data</span>, <span class="kw">filter_vector</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>())
<span class="no">driver_summary_bu_b_only</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/prepare_driver_summary.html">prepare_driver_summary</a></span>(<span class="no">allocation_data</span>, <span class="kw">filter_vector</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">bu</span> <span class="kw">=</span> <span class="st">"bu_b"</span>))</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jimmy Briggs, Oliver Wyman Actuarial Consulting.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
